DROP VIEW IF EXISTS STUDENT_ENROLLMENT CASCADE;
DROP TABLE IF EXISTS Review_Section CASCADE;
DROP TABLE IF EXISTS DEGREE_INFO CASCADE;
DROP TABLE IF EXISTS Thesis CASCADE;
DROP TABLE IF EXISTS Faculty CASCADE;
DROP TABLE IF EXISTS Probation CASCADE;
DROP TABLE IF EXISTS COURSEENROLLMENT CASCADE;
DROP TABLE IF EXISTS PASTCLASS CASCADE;
DROP TABLE IF EXISTS SECTION CASCADE;
DROP TABLE IF EXISTS PASTCLASS CASCADE;
DROP TABLE IF EXISTS Degree_Classes CASCADE;
DROP TABLE IF EXISTS Review_Section CASCADE;
DROP TABLE IF EXISTS Class CASCADE;
DROP TABLE IF EXISTS COURSE CASCADE;
DROP TABLE IF EXISTS Student CASCADE;
DROP TABLE IF EXISTS DEPARTMENT CASCADE;
DROP TABLE IF EXISTS GRADE_CONVERSION CASCADE;
DROP TABLE IF EXISTS regular_meeting CASCADE;


CREATE TABLE DEPARTMENT(
    DEPARTMENTNAME VARCHAR(200) PRIMARY KEY
);

CREATE TABLE DEGREE_INFO (
	DEGREE_NAME VARCHAR(50) ,
    DEPARTMENT_NAME VARCHAR(50),
    Major VARCHAR(50),
    UNIT INT,
    GRADE VARCHAR(10),
	PRIMARY KEY (DEGREE_NAME, Major),
	FOREIGN KEY (DEPARTMENT_NAME) REFERENCES DEPARTMENT(DEPARTMENTNAME)
);

CREATE TABLE Student (
    STUDENTID VARCHAR(50) PRIMARY KEY,
	SSN INT,
    FIRSTNAME VARCHAR(50),
    MIDDLENAME VARCHAR(50),
    LASTNAME VARCHAR(50),
    Enrolled INT,
    Citizenship INT,
    DegreeName VARCHAR(50),
    Major VARCHAR(50),
    FOREIGN KEY (DegreeName,Major) REFERENCES DEGREE_INFO(DEGREE_NAME,Major)
);

CREATE TABLE Faculty (
	FACULTYNAME VARCHAR(255) PRIMARY KEY,
    TITLE VARCHAR(255),
    DEPARTMENT VARCHAR(255),
    FOREIGN KEY (DEPARTMENT) REFERENCES DEPARTMENT(DEPARTMENTNAME)
);
CREATE TABLE COURSE (
    COURSEID VARCHAR(20) PRIMARY KEY,
    COURSENAME VARCHAR(20),
    UNIT INT,
    GRADESTATUS VARCHAR(100),
    PREREQUISITES VARCHAR(100),
    GENERALTOPIC VARCHAR(100),
    INSTRUCTORCONSENT BOOLEAN,
    ISREQUIREDLABWORK BOOLEAN,
    ISLOWER BOOLEAN,
    DEPARTMENT VARCHAR(20),
    FOREIGN KEY (DEPARTMENT) REFERENCES DEPARTMENT(DEPARTMENTNAME)
);
CREATE TABLE Class (
    COURSEID VARCHAR(20),
    COURSETITLE VARCHAR(255),
    QUARTER VARCHAR(255),
    YEAR INT,
    PRIMARY KEY (COURSEID, QUARTER, YEAR),
    FOREIGN KEY (COURSEID) REFERENCES Course(COURSEID)
);
CREATE TABLE SECTION(
    SECTIONID VARCHAR(20),
    COURSEID VARCHAR(20),
    QUARTER VARCHAR(255),
    YEAR INT,
    FacultyName VARCHAR,
    ENROLLMENT_LIMIT INT,
    PRIMARY KEY (SECTIONID, COURSEID, QUARTER, YEAR),
    FOREIGN KEY (COURSEID, QUARTER, YEAR) REFERENCES CLASS (COURSEID, QUARTER, YEAR),
    FOREIGN KEY (FacultyName) REFERENCES Faculty(FACULTYNAME)
);

CREATE TABLE COURSEENROLLMENT (
    STUDENTID VARCHAR(50),
    COURSEID VARCHAR(20),
    SECTIONID VARCHAR(20),
	Quarter VARCHAR(255),
    Year INT,
    unit INT,
    GRADEOPTION INT,
    GRADE VARCHAR(10),
    PRIMARY KEY (STUDENTID,COURSEID,SECTIONID),
    FOREIGN KEY (STUDENTID) REFERENCES STUDENT(STUDENTID),
    FOREIGN KEY (COURSEID) REFERENCES COURSE(COURSEID),
    FOREIGN KEY (SECTIONID, COURSEID, QUARTER, YEAR) REFERENCES SECTION(SECTIONID, COURSEID, QUARTER, YEAR)
);

CREATE TABLE PASTCLASS (
    STUDENTID VARCHAR(50),
    COURSEID VARCHAR(20),
    SECTIONID VARCHAR(20),
    Quarter VARCHAR(255),
    Year INT,
    unit INT,
    GRADEOPTION INT,
    GRADE VARCHAR(10),
    FacultyName VARCHAR,
    PRIMARY KEY (STUDENTID,COURSEID,SECTIONID,QUARTER,YEAR),
    FOREIGN KEY (STUDENTID) REFERENCES STUDENT(STUDENTID),
    FOREIGN KEY (COURSEID, QUARTER, YEAR) REFERENCES CLASS(COURSEID, QUARTER, YEAR),
    FOREIGN KEY (SECTIONID, COURSEID, QUARTER, YEAR) REFERENCES SECTION(SECTIONID, COURSEID, QUARTER, YEAR),
    FOREIGN KEY (FacultyName) REFERENCES Faculty(FACULTYNAME)
);
CREATE TABLE Thesis (
    STUDENTID VARCHAR(255) PRIMARY KEY,
    ADVISORID VARCHAR(255),
    TOPIC VARCHAR(255),
    FOREIGN KEY (STUDENTID) REFERENCES STUDENT(STUDENTID),
    FOREIGN KEY (ADVISORID) REFERENCES FACULTY(FACULTYNAME)
);


CREATE EXTENSION IF NOT EXISTS btree_gist;

CREATE TABLE Probation (
    STUDENTID VARCHAR(50),
    PROBATIONID VARCHAR(50),
	STARTDATE DATE,
    ENDDATE DATE,
    REASON VARCHAR(255),
    PRIMARY KEY (STUDENTID, PROBATIONID),
    FOREIGN KEY (STUDENTID) REFERENCES Student(STUDENTID),
	CONSTRAINT valid_period CHECK (STARTDATE < ENDDATE),
    CONSTRAINT unique_period UNIQUE (STUDENTID, STARTDATE, ENDDATE),
    CONSTRAINT no_overlap EXCLUDE USING GIST (
        STUDENTID WITH =,
        tsrange(STARTDATE, ENDDATE, '[)') WITH &&
    )
);

CREATE TABLE Review_Section (
    COURSEID VARCHAR(20),
	Quarter VARCHAR(255),
    Year INT,
    SECTIONID VARCHAR(20),
	STARTTIME TIMESTAMP,
    ENDTIME TIMESTAMP,
    BUILDING VARCHAR(255),
    PRIMARY KEY (COURSEID, SECTIONID, STARTTIME, ENDTIME),
    FOREIGN KEY (COURSEID,SECTIONID, QUARTER, YEAR) REFERENCES SECTION(COURSEID,SECTIONID, QUARTER, YEAR),
	CONSTRAINT valid_review_period CHECK (STARTTIME < ENDTIME),
    CONSTRAINT unique_review_period UNIQUE (STARTTIME, ENDTIME, BUILDING),
    CONSTRAINT no_review_overlap EXCLUDE USING GIST (
        SECTIONID WITH =,
        COURSEID WITH =,
        tsrange(STARTTIME, ENDTIME, '[)') WITH &&
    )
);

Create Table Degree_Classes(
	DegreeName VARCHAR(50),
	Major VARCHAR(50),
	Category VARCHAR(50),
	Classes VARCHAR(255),
	Unit INT,
	Grade VARCHAR(10),
	Primary Key (DegreeName,Major,Category),
	Foreign Key(DegreeName,Major) REFERENCES Degree_info(Degree_name,Major)
);

CREATE VIEW STUDENT_ENROLLMENT AS
SELECT studentid, courseid, sectionid, quarter, year, unit, gradeoption, grade FROM courseenrollment
UNION
SELECT  studentid, courseid, sectionid, quarter, year, unit, gradeoption, grade  FROM pastclass;

CREATE VIEW ENROLLEDSTUDENTS AS SELECT * FROM STUDENT WHERE enrolled = 1;

create table GRADE_CONVERSION(
		  LETTER_GRADE CHAR(2) NOT NULL,
		  NUMBER_GRADE DECIMAL(2,1)
);

CREATE TABLE regular_meeting (
    meetingid SERIAL PRIMARY KEY,
    SECTIONID VARCHAR(20),
    COURSEID VARCHAR(20),
    QUARTER VARCHAR(255),
    YEAR INT,
    day_of_week VARCHAR(10),
    start_time TIME,
    end_time TIME,
    building VARCHAR(100),
    type VARCHAR(50),
    FOREIGN KEY (SECTIONID, COURSEID, QUARTER, YEAR) REFERENCES section(SECTIONID, COURSEID, QUARTER, YEAR)
);

CREATE OR REPLACE FUNCTION trg_time_conflict()
RETURNS TRIGGER AS $$
BEGIN
    IF EXISTS (
        SELECT 1 FROM REGULAR_MEETING
        WHERE sectionid = NEW.sectionid
          AND courseid = NEW.courseid

          AND day_of_week SIMILAR TO '%' || NEW.day_of_week || '%'
          AND meetingid != NEW.meetingid
          AND (
               (NEW.end_time < end_time AND NEW.end_time > start_time)
            OR (start_time < NEW.start_time AND end_time > NEW.start_time)
            OR (NEW.start_time < start_time AND NEW.end_time > end_time)
          )
    ) THEN
        RAISE EXCEPTION 'Meeting times for the section overlap.';
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

